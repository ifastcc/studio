# **App Name**: ReadFlow

## Core Features:

- Text Input: Text input area to paste text or upload .md/.txt files. The text processing happens on the client side.
- Text Display: Display text with a typewriter effect and Markdown rendering, automatically scrolling to keep the current token visible.
- Text Parsing & Pacing: Parse text into tokens and apply pauses based on punctuation and Markdown structure according to WPM and pause multiplier settings.
- Control Bar: A control bar with play/pause, reset buttons, WPM and pause multiplier settings, and access to the settings panel.
- Keyboard Shortcuts: Implement keyboard shortcuts for play/pause (Spacebar), rewind (Left Arrow), fast forward (Right Arrow), and accelerated playback (Long press Right Arrow).

## Style Guidelines:

- Primary color: Neutral gray (#F5F5F5) for a clean reading experience.
- Secondary color: Dark gray (#333) for text to ensure high contrast.
- Accent color: Teal (#008080) for interactive elements and highlights.
- Clean and minimal design with a focus on readability.
- Subtle animations for the typewriter effect and smooth scrolling.

## Original User Request:
## ReadFlow - 节奏化阅读器 需求文档 

### 1. 引言

#### 1.1 项目目标

ReadFlow 旨在成为一款智能、舒适的节奏化阅读工具。通过解析文本内容（特别是 Markdown 格式），根据预定义的规则和用户设置，以可控的节奏（包括速度和停顿）呈现文本，模拟自然阅读流，减轻用户阅读长文本时的认知负荷和视觉疲劳。此版本旨在整合现有功能并引入更丰富的交互控制（如键盘快捷键），同时为后续代码重构提供清晰的功能蓝图。

#### 1.2 核心价值

*   **智能分段与停顿:** 自动识别文本结构和标点，插入符合阅读习惯的停顿。
*   **可控阅读节奏:** 用户可以自由调整基础阅读速度 (WPM) 和停顿强度。
*   **沉浸式阅读体验:** 提供专注模式、多种主题和背景色，以及流畅的打字机显示效果。
*   **便捷交互:** 支持图形化界面控制和类似播放器的键盘快捷键操作。

#### 1.3 目标用户

*   需要阅读大量数字文本（尤其是 Markdown 格式）的学生、研究人员、开发者、编辑、作家等。
*   希望提高阅读效率和舒适度，减少屏幕阅读疲劳的用户。
*   喜欢通过程序辅助进行阅读的用户。

### 2. 功能需求 (Functional Requirements)

#### FR1: 文本输入与处理

*   **FR1.1 文本粘贴:** 提供一个文本区域，允许用户直接粘贴纯文本或 Markdown 格式的文本。
*   **FR1.2 文件上传:** 支持用户上传本地的 `.md` 或 `.txt` 文件，并将其内容加载到文本区域。应进行文件类型校验。
*   **FR1.3 文本清空:** 提供清空当前文本区域内容的按钮。
*   **FR1.4 处理启动:** 提供“开始阅读”或类似按钮，触发文本处理流程。
    *   **FR1.4.1 客户端处理:** 文本的解析和处理必须在用户浏览器端完成，不依赖服务器。
    *   **FR1.4.2 处理反馈:** 处理过程中应有视觉反馈（如按钮禁用、加载指示器）。
*   **FR1.5 错误处理:**
    *   若文件上传失败或读取错误，应向用户显示明确的错误提示。
    *   若文本内容为空或处理失败，应阻止进入阅读状态并提示用户。

#### FR2: 核心阅读引擎 (Pacer)

*   **FR2.1 文本解析:**
    *   能够解析纯文本和 Markdown 文本。
    *   将文本分解为最小显示单元 (Token)，如单词、单个汉字、标点符号、Markdown 标记等。
*   **FR2.2 智能停顿规则:**
    *   **基于标点:** 在常见的标点符号后自动插入不同时长的停顿（参考 `PAUSE_DURATIONS`，例如：句号 > 问号/感叹号 > 逗号/分号/冒号）。
    *   **基于结构 (Markdown):**
        *   段落之间插入较长停顿。
        *   不同级别的标题 (`#` - `######`) 后插入不同时长的停顿（级别越高，停顿越长）。
        *   列表项结束、引用块结束、代码块结束、分隔线后插入适当停顿。
        *   加粗、斜体、行内代码、链接等元素的开始和结束处可插入微小停顿，以示强调或分隔。
    *   **Token 间基础停顿:** 在非标点、非结构结束的 Token 之间插入非常短暂的基础停顿，影响整体流畅度。
*   **FR2.3 节奏控制参数:**
    *   **WPM (Words Per Minute):** 用户可设置基础阅读速度，引擎根据 WPM 计算每个 Token 的基础显示时长。范围应合理（例如 50-900 WPM）。
    *   **停顿倍率 (Pause Multiplier):** 用户可设置一个倍率，全局调整所有规则化停顿的时长（例如 0.5x - 5.0x）。
*   **FR2.4 状态管理:** 引擎需要管理当前的阅读状态：`Idle` (空闲/未加载), `Ready` (准备就绪), `Playing` (播放中), `Paused` (暂停中), `Finished` (已完成)。
*   **FR2.5 数据输出:** 引擎按计算好的节奏，依次通过回调函数向 UI 层发射需要显示的 Token、是否为 Markdown 标记、以及当前的上下文信息（如是否在加粗/斜体内部）。
*   **FR2.6 进度计算:** 引擎需要能够提供当前的阅读进度（例如，已处理单元数 / 总单元数）。

#### FR3: 阅读界面 (Reader UI)

*   **FR3.1 文本显示区域:**
    *   **打字机效果:** 文本应以累积的方式显示，新 Token 追加到已有文本后面，形成打字机效果。
    *   **Markdown 渲染:** 正确渲染 Markdown 格式（标题、粗体、斜体、列表、引用、代码块、链接等），`SimpleRenderer` 已实现此功能。
    *   **滚动:** 当文本内容超出显示区域时，应能自动平滑滚动，使当前显示的 Token 保持在可视区域内（通常是底部或中心）。
    *   **换行与排版:** 保持原始文本的换行，并应用用户选择的行高和字体大小。
*   **FR3.2 进度指示器:** 在界面上清晰地显示当前的阅读进度条。
*   **FR3.3 视觉定制 (设置面板):**
    *   提供一个弹出式或侧边栏式的设置面板。
    *   **字体大小:** 提供至少三种字体大小选项（小、中、大）。
    *   **行高:** 允许用户通过滑块或预设值调整文本行高。
    *   **背景色:** 提供几种预设的阅读背景色选项（如：默认白/黑、护眼暖色、科技冷色）。
*   **FR3.4 专注模式:**
    *   提供一个开关，进入专注模式。
    *   专注模式下，隐藏除核心阅读区域和必要控制之外的所有干扰元素（如页眉、部分控制按钮、历史记录入口等），阅读区域可能会居中或放大。

#### FR4: 控制交互 (UI & 快捷键)

*   **FR4.1 图形控制栏 (`StickyControlBar`):**
    *   **位置:** 悬浮在页面顶部或用户可选择的位置，保持可见性。
    *   **核心控制:**
        *   播放/暂停按钮 (图标根据状态切换)。
        *   重置按钮 (回到文本开头，状态变为 Ready/Paused)。
    *   **信息显示:**
        *   实时显示当前的 WPM 设置值。
        *   实时显示当前的停顿倍率设置值。
    *   **辅助控制 (可考虑悬停显示):**
        *   打开/关闭设置面板的按钮。
        *   进入/退出专注模式的按钮。
    *   **状态反馈:** 按钮应根据当前状态（如 `isReady`, `isPlaying`）启用或禁用。
*   **FR4.2 键盘快捷键 (新需求):**
    *   **`空格键`:** 切换播放/暂停状态。如果当前是 `Finished` 或 `Idle` 状态，则从头开始播放。
    *   **`左方向键` (←):**
        *   **功能:** 回退 (Rewind)。
        *   **行为:** 将阅读进度回退一小段。具体可以按时间（如回退 3-5 秒对应的 `DisplayUnit` 数量）或按固定 `DisplayUnit` 数量（如回退 50 个单元）实现。需要更新显示的文本和进度条。
    *   **`右方向键` (→):**
        *   **功能:** 快进 (Skip Forward)。
        *   **行为:** 将阅读进度前进一小段。实现方式类似回退。
    *   **`长按右方向键` (→):**
        *   **功能:** 加速播放 (Fast Forward)。
        *   **行为:** 在按住期间，临时提高播放速度（例如，将 WPM 或整体速度因子提高 2-3 倍），松开后恢复原速。需要视觉反馈表明处于加速状态。
    *   **FR4.2.1 快捷键作用域:** 快捷键应在阅读器界面激活时生效，避免与文本输入等其他操作冲突。
    *   **FR4.2.2 禁用:** 在 `Idle` 状态下，除空格键（用于开始）外，其他播放控制快捷键应无效。

#### FR5: 历史记录

*   **FR5.1 自动保存:** 当用户开始处理并阅读一段新文本后，应自动将其（或其摘要/标题）及处理时间存入历史记录。
*   **FR5.2 存储机制:** 使用浏览器 `localStorage` 持久化存储历史记录。
*   **FR5.3 记录上限:** 限制历史记录的数量（例如，最多保存最近 10-20 条）。
*   **FR5.4 历史记录界面 (`HistoryModal`):**
    *   提供入口访问历史记录列表。
    *   列表显示每条记录的标题（可自动生成，如文本前几个词）和保存日期。
    *   **加载:** 点击历史记录项，可以将对应的原始文本加载到输入区，或直接进入阅读准备状态。
    *   **删除:** 提供删除单条历史记录的功能。
    *   **空状态:** 若无历史记录，则显示提示信息。

#### FR6: 主题与外观

*   **FR6.1 主题切换 (`ThemeToggle`):**
    *   支持浅色 (Light) 和深色 (Dark) 两种 UI 主题。
    *   提供明显的切换按钮。
*   **FR6.2 主题持久化:** 将用户选择的主题偏好存储在 `localStorage`。
*   **FR6.3 系统偏好:** 首次加载时，若无本地设置，则优先根据操作系统的颜色方案偏好设置默认主题。
*   **FR6.4 样式一致性:** 所有 UI 元素（按钮、输入框、模态框、阅读区域等）的样式应在不同主题下保持一致性和美观性（利用 CSS 变量）。

### 3. 非功能性需求 (Non-Functional Requirements)

*   **NFR1: 性能:**
    *   **处理速度:** 对于中等长度（如 5 万字符内）的文本，解析和处理时间应在可接受范围内（目标 < 5 秒）。
    *   **渲染流畅度:** 打字机效果、滚动和界面交互应保持流畅，无明显卡顿。
    *   **资源占用:** 避免过高的 CPU 和内存占用，尤其是在长时间阅读时。
*   **NFR2: 可用性:**
    *   **直观性:** 界面布局清晰，核心功能易于发现和使用。
    *   **可读性:** 阅读区域的默认字体、字号、行高、颜色对比度应保证良好的可读性。
    *   **反馈:** 用户的操作（点击按钮、调整设置、使用快捷键）应有及时的视觉反馈。
*   **NFR3: 可靠性:**
    *   **稳定性:** 应用在常见操作下不易崩溃。
    *   **错误处理:** 对预期和意外错误（如解析失败、`localStorage` 写入失败）有优雅的处理机制和用户提示。
*   **NFR4: 可维护性 (重构目标):**
    *   **代码结构:** 重构后的代码应遵循良好的设计原则（如 SOLID），模块化清晰，降低耦合度。
    *   **状态管理:** 采用更系统化的状态管理方案（如 Zustand, Jotai, 或优化 Context API 使用），避免过深的 props drilling。
    *   **代码风格:** 保持一致的代码风格和命名规范。
    *   **类型安全:** 充分利用 TypeScript 的类型系统。
*   **NFR5: 兼容性:**
    *   应在主流现代浏览器（Chrome, Firefox, Safari, Edge）的最新版本上正常工作。
    *   考虑基本的响应式设计，在桌面和平板设备上有良好体验。
*   **NFR6: 数据隐私:**
    *   所有用户输入的文本内容和阅读历史仅存储在用户本地浏览器，不上传至任何服务器。

### 4. 未来考虑 (Optional / Future Scope)

*   **Web Worker:** 将文本处理逻辑移至 Web Worker，避免阻塞 UI 线程，提高大型文本处理性能。
*   **更多 Markdown 扩展:** 支持 GFM 表格、脚注、任务列表等。
*   **高级停顿规则:** 基于词频、词长、语义分析等更复杂的停顿调整（可能需要 NLP 技术）。
*   **云同步:** （需要后端支持）允许用户跨设备同步阅读历史和设置。
*   **导出/导入:** 允许用户导出/导入阅读历史或设置。
*   **多语言支持:** UI 文本国际化。

参考处理规则
**A. 標點符號規則:**

- 句號 (`.` `。`): `[P:500]` (想法完成)
- 問號 (`?` `？`): `[P:600]` (思考時間)
- 感嘆號 (`!` `！`): `[P:550]` (感受情緒)
- 逗號 (`,` `，`): `[P:300]` (從句/短語分隔)
- 分號 (`;` `；`): `[P:400]` (更獨立的子句)
- 冒號 (`:` `：`): `[P:350]` (預備解釋/列表)
- 破折號 (`—` `--` 等): `[P:300]` (句中解釋) / `[P:400]` (句末延續)
- 省略號 (`...` `……`): `[P:450]` (思考/省略)

**B. 結構性規則:**

- 段落之間: `[P:800]` (重要思考間隔)
- H1 後: `[P:1500]` (章節級)
- H2 後: `[P:1200]`
- H3 後: `[P:1000]`
- H4+ 後: `[P:900]`
- 列表開始前: `[P:300]` (預備列舉)
- 列表項結束後: `[P:350]` (獨立信息塊)
- 引用塊開始前: `[P:400]` (視角轉變)
- 引用塊結束後: `[P:500]` (內容整合)
- 代碼塊前: `[P:400]` (模式切換)
- 代碼塊後: `[P:600]` (模式切換)
- 分隔線後: `[P:1000]` (主題轉換)

**C. 行內元素規則:**

- 加粗前: `[P:50]` (預備強調)
- 加粗後: `[P:200]` (吸收強調)
- 斜體後: `[P:150]` (術語/輕度強調)
- 行內代碼前: `[P:150]` (識別術語)
- 行內代碼後: `[P:250]` (處理術語)
- 鏈接文本後: `[P:150]` (識別概念)
- 刪除線後: `[P:100]` (識別否定)
  